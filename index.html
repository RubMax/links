<!DOCTYPE html>
<html>
<head>
    <title>Gestionnaire de Rappels</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f4f4f9; }
        button { cursor: pointer; padding: 10px 20px; background: #4285f4; color: white; border: none; border-radius: 4px; }
        button:hover { background: #357ae8; }
        
        /* Modal pour ajouter des rappels */
        #modal { 
            display: none; 
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            border: none; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); 
            padding: 30px; 
            background: white; 
            z-index: 10; 
            border-radius: 8px; 
            width: 300px; 
        }
        
        /* Modal pour alertes */
        #alertModal { 
            display: none; 
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            border: none; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
            padding: 25px; 
            background: white; 
            z-index: 20; 
            border-radius: 12px; 
            width: 400px; 
            max-height: 80vh; 
            overflow-y: auto; 
        }
        
        .overlay { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 5; 
        }
        
        input, textarea { 
            width: 100%; 
            margin-bottom: 15px; 
            padding: 8px; 
            box-sizing: border-box; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
        }
        
        .rappel-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        #notificationBadge {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #d93025;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            display: none;
            z-index: 15;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

    <h2>Mes Rappels</h2>
    <button onclick="openAddModal()">+ Ajouter un Rappel</button>
    <button onclick="showActiveReminders()" style="background: #d93025; margin-left: 10px;">
        Voir les rappels actifs
    </button>

    <!-- Badge de notification -->
    <div id="notificationBadge" onclick="showActiveReminders()">
        <span id="reminderCount">0</span> rappel(s) actif(s)
    </div>

    <div id="overlay" class="overlay" onclick="closeAll()"></div>
    
    <!-- Modal pour ajouter un rappel -->
    <div id="modal">
        <h3>Nouveau Rappel</h3>
        <input type="text" id="titre" placeholder="Titre">
        <textarea id="details" placeholder="DÃ©tails (facultatif)"></textarea>
        <label>DÃ©but :</label>
        <input type="datetime-local" id="debut">
        <label>Fin :</label>
        <input type="datetime-local" id="fin">
        <input type="email" id="email" placeholder="E-mail (facultatif)">
        <textarea id="message" placeholder="Message Ã  envoyer par e-mail (facultatif)" rows="2"></textarea>

        <button onclick="saveRappel()" style="width: 100%; margin-bottom: 10px;">Enregistrer</button>
        <button onclick="closeAll()" style="width: 100%; background: #666;">Fermer</button>
    </div>

    <!-- Modal pour les alertes -->
    <div id="alertModal">
        <h2 style="color: #d93025; margin-top: 0;">ðŸ”” Rappels Actifs</h2>
        <div id="alertContent"></div>
        <button onclick="closeAll()" style="width: 100%; background: #333; margin-top: 15px;">Fermer</button>
    </div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyCgtLSlxZSPAXG5aezcxXOYFuLbU8yqrGL-LWpzHSfrmEIE8zUpoGhGFUZYUVFSYTx2A/exec";
        
        // Variable pour stocker les rappels actifs
        let activeReminders = [];

        // Fonction pour ouvrir la modal d'ajout
        function openAddModal() {
            document.getElementById('modal').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }

        // Fonction pour fermer toutes les modales
        function closeAll() {
            document.getElementById('modal').style.display = 'none';
            document.getElementById('alertModal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        // Fonction pour sauvegarder un rappel
        async function saveRappel() {
            const titreEl = document.getElementById('titre');
            const detailsEl = document.getElementById('details');
            const debutEl = document.getElementById('debut');
            const finEl = document.getElementById('fin');
            const emailEl = document.getElementById('email');
            const messageEl = document.getElementById('message');

            // Validation des champs requis
            if (!titreEl.value.trim()) {
                alert("Veuillez saisir un titre");
                return;
            }
            if (!debutEl.value || !finEl.value) {
                alert("Veuillez saisir les dates de dÃ©but et fin");
                return;
            }

            // Construction de l'URL
            const params = new URLSearchParams({
                titre: titreEl.value,
                details: detailsEl.value,
                debut: debutEl.value,
                fin: finEl.value,
                email: emailEl ? emailEl.value : "",
                message: messageEl ? messageEl.value : "",
                t: Date.now()
            });

            const url = `${WEB_APP_URL}?${params.toString()}`;

            try {
                await fetch(url, { method: 'GET', mode: 'no-cors' });
                alert("âœ… Rappel, Email et Message enregistrÃ©s !");
                
                // Reset du formulaire
                [titreEl, detailsEl, debutEl, finEl, emailEl, messageEl].forEach(el => {
                    if(el) el.value = "";
                });
                closeAll();
                
                // Mettre Ã  jour la liste des rappels
                await checkReminders(true); // true = ne pas afficher la modal
                
            } catch (e) {
                console.log("Note: Fetch a renvoyÃ© une erreur");
                alert("Enregistrement effectuÃ©. VÃ©rifiez votre feuille Google Sheet.");
                closeAll();
            }
        }

        // Fonction pour marquer un rappel comme accompli
        async function marquerAccompli(titre, details) {
            const url = `${WEB_APP_URL}?action=terminer&titre=${encodeURIComponent(titre)}&details=${encodeURIComponent(details)}&t=${Date.now()}`;
            
            try {
                await fetch(url, { method: 'GET', mode: 'no-cors' });
                alert(`Le rappel "${titre}" a Ã©tÃ© marquÃ© comme fait.`);
                
                // Mettre Ã  jour la liste des rappels
                await checkReminders(true);
                
                // Si on est dans la modal d'alertes, mettre Ã  jour l'affichage
                if (document.getElementById('alertModal').style.display === 'block') {
                    await showActiveReminders();
                }
                
            } catch (e) {
                console.error("Erreur lors de la mise Ã  jour", e);
            }
        }

        // Fonction pour vÃ©rifier les rappels actifs (ne les affiche pas automatiquement)
        async function checkReminders(silent = false) {
            const maintenant = new Date();
            
            try {
                const response = await fetch(WEB_APP_URL + "?t=" + Date.now());
                const rappels = await response.json();
                
                // Filtrer les rappels actifs
                activeReminders = rappels.filter(r => {
                    if (!r[2] || !r[3]) return false;
                    
                    try {
                        const d = new Date(r[2]);
                        const f = new Date(r[3]);
                        
                        // VÃ©rifier si les dates sont valides
                        if (isNaN(d.getTime()) || isNaN(f.getTime())) {
                            return false;
                        }
                        
                        return (maintenant >= d && maintenant <= f && 
                                r[4] && r[4].toString().toLowerCase() === "non");
                    } catch (e) {
                        console.error("Erreur de date:", e);
                        return false;
                    }
                });

                // Mettre Ã  jour le badge de notification
                updateNotificationBadge();
                
                // Afficher la modal seulement au premier chargement (si silent = false)
                if (!silent && activeReminders.length > 0) {
                    // Afficher la modal seulement au premier chargement de la page
                    // (pas Ã  chaque intervalle)
                    const firstLoad = localStorage.getItem('firstLoad') !== 'false';
                    if (firstLoad) {
                        await showActiveReminders();
                        localStorage.setItem('firstLoad', 'false');
                    }
                }
                
            } catch (e) {
                console.error("Erreur de synchronisation:", e);
            }
        }

        // Fonction pour afficher la modal des rappels actifs
        async function showActiveReminders() {
            if (activeReminders.length === 0) {
                await checkReminders(true);
            }
            
            if (activeReminders.length > 0) {
                let html = "";
                activeReminders.forEach(r => {
                    html += `
                        <div class="rappel-item">
                            <div style="flex: 1;">
                                <strong>${r[0] || ''}</strong><br>
                                <small>${r[1] || ""}</small><br>
                                <small style="color: #666;">
                                    ${formatDate(r[2])} - ${formatDate(r[3])}
                                </small>
                            </div>
                            <button onclick="marquerAccompli('${(r[0] || '').replace(/'/g, "\\'")}', 
                                    '${(r[1] || '').replace(/'/g, "\\'")}')" 
                                    style="background: #28a745; padding: 5px 10px; font-size: 0.8em; margin-left: 10px;">
                                Accomplir
                            </button>
                        </div>`;
                });
                document.getElementById('alertContent').innerHTML = html;
                document.getElementById('alertModal').style.display = 'block';
                document.getElementById('overlay').style.display = 'block';
                
                // Masquer le badge de notification
                document.getElementById('notificationBadge').style.display = 'none';
            } else {
                alert("Aucun rappel actif pour le moment.");
            }
        }

        // Fonction pour formater la date
        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleString('fr-FR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return dateString;
            }
        }

        // Fonction pour mettre Ã  jour le badge de notification
        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            const countSpan = document.getElementById('reminderCount');
            
            if (activeReminders.length > 0) {
                countSpan.textContent = activeReminders.length;
                badge.style.display = 'block';
                
                // Ajouter une animation pour attirer l'attention
                badge.style.animation = 'pulse 1s';
                setTimeout(() => {
                    badge.style.animation = '';
                }, 1000);
            } else {
                badge.style.display = 'none';
            }
        }

        // VÃ©rification au chargement et toutes les 10 minutes
        document.addEventListener('DOMContentLoaded', function() {
            // Marquer que c'est le premier chargement
            localStorage.setItem('firstLoad', 'true');
            
            // VÃ©rifier les rappels au chargement (modal s'affiche si besoin)
            checkReminders();
            
            // VÃ©rifier toutes les 10 minutes (sans afficher la modal)
            setInterval(() => {
                checkReminders(true); // true = mode silencieux
            }, 3 * 60 * 1000);
            
            // VÃ©rifier aussi toutes les minutes pour les notifications en temps rÃ©el
            setInterval(() => {
                checkReminders(true);
            }, 60 * 1000);
        });

        // Style pour l'animation du badge
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.1); }
                100% { transform: scale(1); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>

